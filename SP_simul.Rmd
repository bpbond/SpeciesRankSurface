# Multifractal analysis of multispecies spatial distributions - Spatial patterns simulations

I generate different a spatial patterns to compare SRSDq SADdq and SAD

```{r setup, eval=T }
load(".RData")

simul  <- F # variable to perform or not the simulations

oldcd <-getwd()
source("R/Neutral_fun.r")

# Set the location of the binary 
#
mfBin <- "~/Dropbox/cpp/SpatialAnalysis/mfsba" # /mfSBA /multiSpeciesSBA

require(pander)
panderOptions('table.split.table',Inf)
options("scipen"=100, "digits"=4)

```

# Banded pattern of species with uniform  SAD 256 side

First generate a pattern with  SAR z=1 using simply bands of species z=0.5 because I am using area as Borda-de-Agua instead of side.

```{r simul_z1, eval=F,echo=F,message=F,warning=F}
setwd("Simul")

DqF <- compMethods_UniformSAD(8,256)

DqF <- rbind(DqF,compMethods_UniformSAD(64,256))

DqF <- rbind(DqF,compMethods_UniformSAD(256,256))

# Analizing this last it means that the scaling is broken at side 16
#  
#Dq2<- calcDq_multiSBA(fname1,"q.sed 16 1024 20 E",mfBin,T)
#Dq2$Type <- "rnzDqSAD16-512"
#Dq3<- rbind(Dq3,Dq2)
#
##Dq2<- calcDq_multiSBA(fname1,"q.sed 2 16 20 E",mfBin,T)
#Dq2$Type <- "rnzDqSAD2-16"
#Dq3<- rbind(Dq3,Dq2)
#plotDq(Dq3,"Type")

pandoc.table(DqF[DqF$R.Dq<0.8,],caption="R2<0.8")
setwd(oldcd)
```

* For SRS the positive part seems to reflect the equal SAD and the negative the spatial pattern


# Banded pattern 64 species 512 side

To see if there is any efect of side 

```{r simul_z1_512, eval=F,echo=F,message=F,warning=F}
setwd("Simul")



DqF <- rbind(DqF,compMethods_UniformSAD(64,512))


setwd(oldcd)
```

Thus DqSAD works in the range 2-8 2-16 2-32 depending on the number of species

# Now simulate an image with logseries SAD with 8, 64 & 256 species

# Test logseries SAD side = 256 

```{r simul_ls_256, eval=F,echo=F,message=F,warning=F}
setwd("Simul")

DqF <- rbind(DqF,compMethods_FisherSAD(8,256))

DqF <- rbind(DqF,compMethods_FisherSAD(64,256))

DqF <- rbind(DqF,compMethods_FisherSAD(256,256))

setwd(oldcd)

```

# Test logseries SAD side=512 

```{r simul_ls_512b, eval=F,echo=F,message=F,warning=F}
setwd("Simul")

DqF <- rbind(DqF,compMethods_FisherSAD(8,512))

DqF <- rbind(DqF,compMethods_FisherSAD(64,512))

DqF <- rbind(DqF,compMethods_FisherSAD(256,512))

setwd(oldcd)
rm(Dq1,Dq2,spa)

```

# Simulate with logseries and the neutral model

```{r simul_neu_256, eval=F,echo=F,message=F,warning=F}
setwd("Simul")


DqF <- rbind(DqF,compMethods_NeutralSAD(8,256,T)$Dq)


DqF <- rbind(DqF,compMethods_NeutralSAD(64,256,T)$Dq)


DqF <- rbind(DqF,compMethods_NeutralSAD(256,256,T)$Dq)
setwd(oldcd)
rm(nsp,side,spa)

save.image()
```

# Test if at time 500 the model is at steady state

```{r test_neutralTime, eval=F,echo=F,message=F,warning=F}
setwd("Simul")

simul_NeutralPlotTime(8,256,T,500,"L")
simul_NeutralPlotTime(64,256,T,500,"L")
simul_NeutralPlotTime(256,256,T,500,"L")


simul_NeutralPlotTime(8,512,T,500,"L")
simul_NeutralPlotTime(64,512,T,500,"L")
simul_NeutralPlotTime(256,512,T,500,"L")


simul_NeutralPlotTime(8,512,T,500,"U")
simul_NeutralPlotTime(64,512,T,500,"U")
simul_NeutralPlotTime(256,512,T,500,"U")

setwd(oldcd)

```


Perform Neutral with metaccomunity uniform and Uniform, 10 simulations with side 256 and 512


```{r test_SAD256U, eval=F,echo=F,message=F,warning=F}
setwd("Simul")

cc <- comp_NeutralUniform(8,256)
DqUN   <-cc$Dq
SadUN  <-cc$SAD

cc <- comp_NeutralUniform(64,256)
DqUN   <-rbind(DqUN  ,cc$Dq)
SadUN  <-rbind(SadUN ,cc$SAD)

cc <- comp_NeutralUniform(256,256)
DqUN   <-rbind(DqUN  ,cc$Dq)
SadUN  <-rbind(SadUN ,cc$SAD)


cc <- comp_NeutralUniform(8,512)
DqUN   <-rbind(DqUN  ,cc$Dq)
SadUN  <-rbind(SadUN ,cc$SAD)

cc <- comp_NeutralUniform(64,512)
DqUN   <-rbind(DqUN  ,cc$Dq)
SadUN  <-rbind(SadUN ,cc$SAD)

cc <- comp_NeutralUniform(256,512)
DqUN   <-rbind(DqUN  ,cc$Dq)
SadUN  <-rbind(SadUN ,cc$SAD)

rm(cc)



# merge SAD
SadT <- rbind(SadGC,SadUN)
rm(SadGC,SadUN)

# merge Dq

DqT <- rbind(DqGC,DqUN)
rm(DqGC,DqUN)

setwd(oldcd)
save.image()


#compT <- rbind(compT,compUN)
#SadT <- rbind(SadT,SadUN)
#DqT  <- rbind(DqT,DqUN)

```


Perform Neutral with metacommunity logseries and Logseries, 10 simulations with side =256/512


```{r test_SAD256, eval=T,echo=F,message=F,warning=F}
setwd("Simul")

cc <- comp_NeutralLogseries(8,256)
DqT   <-rbind(DqT,cc$Dq)
SadT  <-rbind(SadT ,cc$SAD)

cc <- comp_NeutralLogseries(64,256)
DqT   <-rbind(DqT  ,cc$Dq)
SadT  <-rbind(SadT ,cc$SAD)

cc <- comp_NeutralLogseries(256,256)
DqT   <-rbind(DqT  ,cc$Dq)
SadT  <-rbind(SadT ,cc$SAD)

cc <- comp_NeutralLogseries(8,512)
DqT   <-rbind(DqT  ,cc$Dq)
SadT  <-rbind(SadT ,cc$SAD)

cc <- comp_NeutralLogseries(64,512)
DqT   <-rbind(DqT  ,cc$Dq)
SadT  <-rbind(SadT ,cc$SAD)

cc <- comp_NeutralLogseries(256,512)
DqT   <-rbind(DqT  ,cc$Dq)
SadT  <-rbind(SadT ,cc$SAD)


# Simulations with side=512 not done
#
#compSP <- rbind(compSP,compKS_NeutralLogseries(8,512))
#compSP <- rbind(compSP,compKS_NeutralLogseries(64,512))
#compSP <- rbind(compSP,compKS_NeutralLogseries(256,512))
rm(cc)


setwd(oldcd)
save.image()
```

Now check if all simulations are done a make power calculations

```{r power_adtest, eval=T,echo=F,message=F,warning=F}
# Check all simulations are present
require(plyr)
ddply(SadT,3:6,summarize, max(rep))
ddply(DqT,5:8,summarize, max(rep),min(rep))
powad <- data.frame()

powad <- rbind(powad,calcPower_AD(DqT,SadT,8,256))
powad <- rbind(powad,calcPower_AD(DqT,SadT,64,256))
powad <- rbind(powad,calcPower_AD(DqT,SadT,256,256))

powad <- rbind(powad,calcPower_AD(DqT,SadT,8,512))
powad <- rbind(powad,calcPower_AD(DqT,SadT,64,512))
powad <- rbind(powad,calcPower_AD(DqT,SadT,256,512))

save.image()
```

Make plots of power and type I error 

```{r power_adtest, eval=T,echo=F,message=F,warning=F}

plot_DqPowerTypeI <- function(pp,tit){
  require(ggplot2)
  pp$Type2[pp$Type2=="SRS"] <- "DqSRS" 
  pp$Type2[grepl("rnz",pp$Type2)] <- "Power"
  pp$Type2[grepl("Dq",pp$Type2)] <- "Type I"

  g <-ggplot(pp, aes(factor(NumSp), power, colour = as.factor(Side))) +
    geom_point(aes(shape=as.factor(Side)),size=4) + ggtitle(tit) + theme_bw() +
    facet_grid(Type1~Type2) + scale_colour_discrete(name="Size") +
    scale_shape_discrete(name="Size") + scale_x_discrete(name="Number of Species")
  print(g)
}
#powad <- power
p1 <- with(powad, powad[grepl("^DqSAD|^SRS",Type1) & SAD1==SAD2 & SAD1=="Uniform" ,])
plot_DqPowerTypeI(p1,"Uniform")


p1 <- with(powad, powad[grepl("^DqSAD|^SRS",Type1) & SAD1==SAD2 & SAD1=="NeuUnif" ,])
plot_DqPowerTypeI(p1,"NeuUnif")

p1 <- with(powad, powad[grepl("^DqSAD|^SRS",Type1) & SAD1==SAD2 & SAD1=="Logseries" ,])
plot_DqPowerTypeI(p1,"Logseries")

p1 <- with(powad, powad[grepl("^DqSAD|^SRS",Type1) & SAD1==SAD2 & SAD1=="Neutral" ,])
plot_DqPowerTypeI(p1,"Neutral")


```

