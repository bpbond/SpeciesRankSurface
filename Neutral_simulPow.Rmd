# Multifractal analysis of multispecies spatial distributions - Model simulations 

I generate parameter files for the simulation of neutral/hierarchical model using logseries as the metacommunity distribution


```{r setup, eval=T }

simul  <- F # variable to perform or not the simulations

oldcd <-getwd()
source("R/Neutral_fun.r")

# Set the location of the binary 
#
neuBin <- "~/Dropbox/cpp/CaNew/Neutral/ipsNeutralExp"


require(pander)
panderOptions('table.split.table',Inf)
options("scipen"=100, "digits"=4)
```

## Simulations with different parameters using pomac and at Time=100

Now I will simulate the model to Time=500 with a full set of parameters 
Replacement = 0,0.001,0.01,0.1,1 and ten repetitions 



```{r simul_LogSerParms, eval=T,echo=F,message=F,warning=F}
setwd("Simul")

time <- 500
meta <- "L"
side <- 256
nsp  <- 64

if(toupper(meta)=="L") {
  prob <- genFisherSAD(nsp,side)
  neuParm <- "fishE"
  bname <- paste0("neuFish",nsp)
  sadName <- "Neutral"
} else {
  prob <- rep(1/nsp,nsp)  
  neuParm <- "unifE"
  bname <- paste0("neuUnif",nsp)
  sadName <- "NeuUnif"
}

# Parameters
#
# Mortality = 0.2 - 0.4
# Mean Dispersal distance 25  -> Exponential kernel parm  0.04
#                         2.5 -> 0.4
# Colonization = 0.001 -0.0001
# Replacement  = 0 - 1
spMeta <- length(prob)
# First generate de inp file with species and metacommunity parameters 
genNeutralParms(neuParm,side,prob,1,0.2,0.04,0.0001)

# Delete old simulations
system(paste0("rm ",bname,"*.txt"))


# we need the par file with the simulations parameters
par <- read.table("sim.par",quote="",stringsAsFactors=F)


# Number of time steps 
par[par$V1=="nEvals",]$V2 <- time
par[par$V1=="inter",]$V2 <- time # interval to measure Density and Diversity
par[par$V1=="init",]$V2 <- time  # Firs time of measurement = interval
par[par$V1=="modType",]$V2 <- 4 # Hierarchical saturated
par[par$V1=="sa",]$V2 <- "N" # Save a snapshot of the model
par[par$V1=="baseName",]$V2 <- paste0(bName ,"T", time ) 
par[par$V1=="pomac",]$V2 <- 1 # 0:one set of parms 
                              # 1:several simulations with pomac.lin parameters 

write.table(par, "sim.par",sep="\t",row.names=F,col.names=F,quote=F)

# Then pomac.lin to simulate a range of parmeters and repetitions.
#
# Generates pomac.lin for multiple simulations exponential dispersal to compare hierarchical and neutral communities  
# and see when they have similar H and compare if they have similar SAD

genPomacParms("pomExp",1,c(0.2),c(0.04),c(0.0001),c(0,0.001),3)

#genPomacParms("pomExp",1,c(0.2,0.4),c(0.04,0.4),c(0.001,0.0001),c(0,0.001,0.01,0.1,1),10)

# copy pomExp.lin to pomac.lin
system("cp pomExp.lin pomac.lin")

system(paste(neuBin,"sim.par",paste0(neuParm,".inp")))


# Desde aca function compNeutral_Time  
#
fname <- paste0(bname,"T",time,"Density.txt")

den1 <- meltDensityOut_NT(fname,spMeta)

# Test pairwise diferences in SAD
#
mKS <- pairwiseAD_Dif(den1,"value",den1[,1:5])

# Plot the first pairs not different 
#
mks <- mKS[mKS$p.value>0.05,2:ncol(mKS)]
psa <- mergePairSadRank(mks[1,],den1,"value",1:5)
psa <- rbind(psa,mergePairSadRank(mks[nrow(mks),],den1,"value",1:5))
require(ggplot2)
(g <- ggplot(psa,aes(x=Rank,y=log(value),colour=parms)) + geom_line() + ggtitle("SAD not dif"))

# Build data.frame with proportions
#
#compM <- data.frame(time=Time,notdif=propNotDiffSAD(mKS),method="SAD")


######################### HAY QUE VER DE LOS QUE SON IGUALES si dan distintos con DqSAD /SRS
qNumber <- 35
fname <- paste0(bname,"T",time,"mfOrd.txt")
Dq1 <- readNeutral_calcDq(fname)
Dq1$rep <- rep( 1:(nrow(Dq1)/qNumber),each=qNumber)

mKS1 <- pairwiseAD_Dif(Dq1,"Dq",den1[,c(1:4,10])   #### TEST THIS!

#

setwd(oldcd)
rm(Dq1,den1)
rm(den1,den,mks1,mks,mks100)
save.image()

```

## Simulations at Time=500


```{r simul_pomac467_T500, eval=T,echo=F,message=F,warning=F }
load(".RData")

setwd("Simul")

# read par file with simulations parameters
if(simul)
{
  # Delete old simulations
  system("rm Exp467T500*")
    
  par <- read.table("sim.par",quote="",stringsAsFactors=F)
  
  # Number of time steps 
  par[par$V1=="nEvals",]$V2 <- 500
  par[par$V1=="inter",]$V2 <- 500 # interval to measure Density and Diversity
  par[par$V1=="init",]$V2 <- 500  # Firs time of measurement = interval
  par[par$V1=="modType",]$V2 <- 4 # Hierarchical saturated
  par[par$V1=="sa",]$V2 <- "N" # Save a snapshot of the model
  par[par$V1=="baseName",]$V2 <- paste0("Exp",spMeta,"T500")
  par[par$V1=="pomac",]$V2 <- 1 # 0:one set of parms 
                                # 1:several simulations with pomac.lin parameters 
  
  write.table(par, "sim.par",sep="\t",row.names=F,col.names=F,quote=F)
  
  # I will not delete old simulations
  # system("rm Exp467*")
  
  # I have to modify pomExp.lin to make different simulations
  
  genPomacParms("pomExp",1,c(0.2,0.4),c(0.04,0.4),c(0.001,0.0001),c(0,0.001,0.01,0.1,1),10)
  
  # copy pomExp.lin to pomac.lin
  system("cp pomExp.lin pomac.lin")
  
  s <- paste(neuBin,"sim.par","fishE.inp")
  s
  system(s,wait=F)
}

m <- compMethods_Time(bName,500,spMeta) 


compM <- rbind(compM,m$compM)

pander(compM,caption="Proportion of not different")


mks1 <- m$mPval
mks1 <- mks1[mks1$method=="DqSAD" & mks1$p.adjust>0.05,]
pander(mks1,caption="DqSAD not different T=500")

Dq1 <- readNeutral_calcDq(paste0(bName,"T500mfSAD.txt"))

mergePair_plotDq(mks1[1,],Dq1,"DqSAD not different T=500")

mPval <- rbind(mPval,m$mPval)

mks1 <- mPval[mPval$method=="DqSAD" & mPval$p.adjust>0.05,]


setwd(oldcd)
rm(Dq1,m,mks1)
save.image()

```

Now the same set of simulations for T=1000

```{r simul_pomac467_T1000, eval=T,echo=F,message=F,warning=F}

# Load data if run only one chunk 
#load(".RData")

setwd("Simul")

if(simul)
{
  # Delete old simulations
  system("rm Exp467T1000*")
    
  # read par file with simulations parameters

  par <- read.table("sim.par",quote="",stringsAsFactors=F)

  # Number of time steps 
  par[par$V1=="nEvals",]$V2 <- 1000
  par[par$V1=="inter",]$V2 <- 1000 # interval to measure Density and Diversity
  par[par$V1=="init",]$V2 <- 1000  # Firs time of measurement = interval
  par[par$V1=="modType",]$V2 <- 4 # Hierarchical saturated
  par[par$V1=="sa",]$V2 <- "N" # Save a snapshot of the model
  par[par$V1=="baseName",]$V2 <- paste0("Exp",spMeta,"T1000")
  par[par$V1=="pomac",]$V2 <- 1 # 0:one set of parms 
                                # 1:several simulations with pomac.lin parameters 

  write.table(par, "sim.par",sep="\t",row.names=F,col.names=F,quote=F)

  # I have to modify pomExp.lin to make different simulations

  genPomacParms("pomExp",1,c(0.2,0.4),c(0.04,0.4),c(0.001,0.0001),c(0,0.001,0.01,0.1,1),10)

  # copy pomExp.lin to pomac.lin
  system("cp pomExp.lin pomac.lin")

  s <- paste(neuBin,"sim.par","fishE.inp")
  s
  if(simul) system(s,wait=F)
}

m <- compMethods_Time(bName,1000,spMeta) 

compM <- rbind(compM,m$compM)

pander(compM,caption="Proportion of not different")


mks1 <- m$mPval
mks1 <- mks1[mks1$method=="DqSAD" & mks1$p.adjust>0.05,]
pander(mks1,caption="DqSAD not different T1000")

mPval <- rbind(mPval,m$mPval)

setwd(oldcd)
rm(m,mks1)
save.image()


``` 

The the proportion of different SAD is constant from T=500 it seems we reach steady state. I have to compare now using H and Dq, for that I should do repeated simulations
of each combination.

```{r plot_Time_pomac467,eval=T,echo=F,message=F,warning=F}

setwd("Simul")

# Plot different SAD with time

# Plot different Dq SRS with time

Dq1 <- readNeutral_calcDq(paste0(bName,"T100mfOrd.txt"))
Dq1 <- rbind(Dq1,readNeutral_calcDq(paste0(bName,"T500mfOrd.txt")))
Dq1 <- rbind(Dq1,readNeutral_calcDq(paste0(bName,"T1000mfOrd.txt")))

mks1 <- mPval[mPval$method=="SRS" & mPval$p.adjust>0.05,]

mergePair_plotDq(mks1[1,],Dq1,"SRS not different")

mks1 <- mPval[mPval$method=="SRS" & mPval$p.adjust<=0.05,]

mergePair_plotDq(mks1[4,],Dq1,"SRS different")


# Plot different Dq SAD with time


Dq1 <- readNeutral_calcDq(paste0(bName,"T100mfSAD.txt"))
Dq1 <- rbind(Dq1,readNeutral_calcDq(paste0(bName,"T500mfSAD.txt")))
Dq1 <- rbind(Dq1,readNeutral_calcDq(paste0(bName,"T1000mfSAD.txt")))

mks1 <- mPval[mPval$method=="DqSAD" & mPval$p.adjust>0.05,]

mergePair_plotDq(mks1[1,],Dq1,"DqSAD not different")

mks1 <- mPval[mPval$method=="DqSAD" & mPval$p.adjust<=0.05,]

mergePair_plotDq(mks1[4,],Dq1,"DqSAD different")



setwd(oldcd)

```

```{r compKS_pomac467,eval=T,echo=F,message=F,warning=F}
source("R/Neutral_fun.r")

setwd("Simul")

m <- compMethod_DqKS_Time(bName,100,spMeta) 

compM <- rbind(compM,m$compM)

pander(compM,caption="Proportion of not different")

mPval <- rbind(mPval,m$mPval)


m <- compMethod_DqKS_Time(bName,500,spMeta) 
compM <- rbind(compM,m$compM)
pander(compM,caption="Proportion of not different")
mPval <- rbind(mPval,m$mPval)


m <- compMethod_DqKS_Time(bName,1000,spMeta) 
compM <- rbind(compM,m$compM)
pander(compM,caption="Proportion of not different")
mPval <- rbind(mPval,m$mPval)

setwd(oldcd)

rm(m)

compM

save.image()

names(mPval)
unique(mPval$method)
m <- with(mPval,mPval[method=="DqSADKS" & time==100,])
propNotDiffSAD(m)



```

