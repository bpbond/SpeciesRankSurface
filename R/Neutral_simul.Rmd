# Multifractal analysis of multispecies spatial distributions - Model simulations 

I generate parameter files for the simulation of neutral/hierarchical model using logseries as the metacommunity distribution


```{r generateLogSerParms}

s_wait <- F # variable to make R wait until simulations ends or not 

oldcd <-getwd()
source("R/Neutral_fun.r")

# Generate a SAD for metacommunity using a logseries 
#
# side is the side of the simulation lattice
#
# N is the total number of individuals 
#
# S is the species richness 
#

require(untb)
side <- 500
N <- side*side
S <- 450 
ff<-fisher.ecosystem(N=N,S=S,nmax=N)
plot(ff)
nrow(ff)
ff <- data.frame(sp="",FreqT=as.numeric(ff),prob=0,Ord=1:length(ff))
ff$prob <- ff$FreqT/sum(ff$FreqT)

# Parameters
#
# Mortality = 0.2 - 0.4
# Mean Dispersal distance 25  -> Exponential kernel parm  0.04
#                         2.5 -> 0.4
# Colonization = 0.001 -0.0001
# Replacement  = 0 - 1

setwd("Simul")
#undebug(genNeutralParms)
# First generate de inp file with species and metacommunity parameters 
genNeutralParms("fishE",500,ff$prob,1,0.2,0.04,0.001)

# Then pomac.lin to simulate a range of parmeters and repetitions.
#
# Generates pomac.lin for multiple simulations exponential dispersal to compare hierarchical and neutral communities  
# and see when they have similar H and compare if they have similar SAD

genPomacParms("pomExp",1,c(0.2,0.4),c(0.04,0.4),c(0.001,0.0001),c(0,1))

# we need the par file with the simulations parameters

par <- read.table("sim.par",quote="",stringsAsFactors=F)
# Change base name

# Number of time steps 
par[par$V1=="nEvals",]$V2 <- 100
# Change interval to measure Density and Diversity
par[par$V1=="inter",]$V2 <- 10
par[par$V1=="modType",]$V2 <- 4 # Hierarchical saturated
par[par$V1=="sa",]$V2 <- "S" # Save a snapshot of the model
par[par$V1=="baseName",]$V2 <- paste0("Exp",nrow(ff))
par[par$V1=="pomac",]$V2 <- 0 # 0:one set of parms 
                              # 1:several simulations with pomac.lin parameters 


write.table(par, "sim.par",sep="\t",row.names=F,col.names=F,quote=F)


# Run the model with the parameter ReplacementRate turned on = Hierarchical 
# and exponential dispersal 
#
# Set the location of the binary 
neuBin <- "~/Dropbox/cpp/CaNew/Neutral/ipsNeutralExp"

# copy pomExp.lin to pomac.lin
system("cp pomExp.lin pomac.lin")


system(paste(neuBin,"sim.par","fishE.inp"),wait=s_wait)



```

Now I will read the output generated from simulations (not from pomac) to test if the SAD are equal in time using Kolmogorov Smirnov test. 

```{r testRAD_KS}

den <- read.delim("Simul/Exp467Density.txt")
names(den)[1:5]<-c("GrowthRate","MortalityRate","DispersalDistance","ColonizationRate","ReplacementRate")
  
# from 7 to 473 there are species densities

require(reshape2)

# Put simpler names to variables to identify species
names(den)[7:473]<-as.character(1:467)

den1 <- melt(den,id.vars=c("Time"),measure.vars=c(7:473),variable.name="Species")

# Kolmogorov-smirnov test for two distributions

with(den1,ks.test(den1[Time==10 & value>0,]$value,den1[Time==100 & value>0,]$value))

require(ggplot2)
#den2<-with(den1,den1[Time==90 & value>0,])
#den2 <- den2[order(den2$value),]
#den2$Ord <- nrow(den2):1

require(plyr)

den2 <- ddply(den1,.(Time), function(x) { 
  #tmp <- x[x$value>0,]
  tmp <- x[order(x$value),]
  tmp$Ord <- nrow(x):1
  data.frame(tmp)
  })
den2 <- with(den2,den2[value>0 & (Time==10 | Time==100),])
g <- ggplot(den2,aes(x=Ord,y=log(value),colour=as.character(Time))) + geom_line()
g


```

Thus the SAD at Time=10 is not different from Time=100

Let try simulations with different parameters using pomac and at Time=100
 
```{r simul_pomac467}

setwd("Simul")

# we need the par file with the simulations parameters

par <- read.table("sim.par",quote="",stringsAsFactors=F)
# Change base name

# Number of time steps 
par[par$V1=="nEvals",]$V2 <- 100
# Change interval to measure Density and Diversity
par[par$V1=="inter",]$V2 <- 100
par[par$V1=="init",]$V2 <- 100

par[par$V1=="modType",]$V2 <- 4 # Hierarchical saturated
par[par$V1=="sa",]$V2 <- "S" # Save a snapshot of the model
par[par$V1=="baseName",]$V2 <- paste0("Exp",nrow(ff))
par[par$V1=="pomac",]$V2 <- 1 # 0:one set of parms 
                              # 1:several simulations with pomac.lin parameters 

write.table(par, "sim.par",sep="\t",row.names=F,col.names=F,quote=F)

# delete old simulations
system("rm Exp467*")


# copy pomExp.lin to pomac.lin
system("cp pomExp.lin pomac.lin")


system(paste(neuBin,"sim.par","fishE.inp"),wait=s_wait)

```

Now I will read the densities for different parameters and test SADs and Shannon

```{r testKS_pomac467}

den1 <- meltDensityOut_NT("Simul/Exp467Density.txt",nrow(ff))

# Kolmogorov-smirnov test for two distributions

parms <- unique(den1[,1:4])
combo <- combn(nrow(parms),2)

require(plyr)
mks <-adply(combo,2, function(x) {
      p1 <- parms[x[1],]
      p2 <- parms[x[2],]
      d1 <- merge(den1,p1)
      d2 <- merge(den1,p2)
      ks <- ks.test(d1$value,d2$value)
      out <-data.frame(p1,p2,t(paste(p1,p2,sep="_")),p.value=ks$p.value,stringsAsFactors=F)
      ln <-length(names(p1))*3
      names(out)[1:ln]<-c(paste0(abbreviate(names(p1)),1),paste0(abbreviate(names(p1)),2),names(p1))
      return(out)      
      })

#p1 <- parms[1,]
#p2 <- parms[9,]
#d1 <- merge(den1,p1)
#d2 <- merge(den1,p2)
#ks <- ks.test(d1$value,d2$value)
#out <-data.frame(p1,p2,t(paste(p1,p2,sep="_")),p.value=ks$p.value,stringsAsFactors=F)
#ln <-length(names(p1))*3
#names(out)[1:ln]<-c(paste0(abbreviate(names(p1)),1),paste0(abbreviate(names(p1)),2),names(p1))
#rm(d1,d2,p1,p2,out,ks,ln)



mks$p.adjust <- p.adjust(mks$p.value, method="hommel")

# wich are not different

format(mks[mks$p.adjust>0.05,c(10:13,14:15)],digits=4)
format(mks[mks$p.adjust>0.1,c(10:13,14:15)],digits=4)

format(mks[mks$p.value>0.01,c(10:13,14:15)],digits=4)



# SE PODRIA HACER CON ddply para hacer varias filas del mks !!!!!

#den2 <- ddply(den1,.(Time), function(x) { 
  #tmp <- x[x$value>0,]
#  tmp <- x[order(x$value),]
#  tmp$Ord <- nrow(x):1
#  data.frame(tmp)
#  })

format(mks[mks$p.value<0.05 & mks$p.adjust>0.05,c(10:13,14:15)],digits=4)

psa <-mergePairSAD(mks[61,],den1)
# p.value = 
require(ggplot2)
g <- ggplot(psa,aes(x=Rank,y=log(value),colour=parms)) + geom_line()
g

psa <- mergePairSAD(mks[105,],den1)
(g <- ggplot(psa,aes(x=Rank,y=log(value),colour=parms)) + geom_line())
g + geom_point()
```

In this case there are no semejant SAD for different mechanisms (neutral vs hierarchical) but some of adjusted p values lead to not reject differences when SADs seems different like mks[61,],105,107

Now I will simulate with a smaller Replacement = 0.01 / 0.1 and compare with Replacement=0


```{r simul_pomac467_R001,echo=F,message=F,warning=F}

setwd("Simul")

# read par file with simulations parameters

par <- read.table("sim.par",quote="",stringsAsFactors=F)

# Number of time steps 
par[par$V1=="nEvals",]$V2 <- 100

par[par$V1=="inter",]$V2 <- 100 # interval to measure Density and Diversity
par[par$V1=="init",]$V2 <- 100  # Firs time of measurement = interval
par[par$V1=="modType",]$V2 <- 4 # Hierarchical saturated
par[par$V1=="sa",]$V2 <- "N" # Save a snapshot of the model
par[par$V1=="baseName",]$V2 <- paste0("Exp",nrow(ff))
par[par$V1=="pomac",]$V2 <- 1 # 0:one set of parms 
                              # 1:several simulations with pomac.lin parameters 

write.table(par, "sim.par",sep="\t",row.names=F,col.names=F,quote=F)

# I will not delete old simulations
# system("rm Exp467*")

# I have to modify pomExp.lin to make different simulations
#undebug(genPomacParms)

genPomacParms("pomExp",1,c(0.2,0.4),c(0.04,0.4),c(0.001,0.0001),c(0.01))

# copy pomExp.lin to pomac.lin
system("cp pomExp.lin pomac.lin")


system(paste(neuBin,"sim.par","fishE.inp"),wait=s_wait)

# add more paremeter combinations 
genPomacParms("pomExp",1,c(0.2,0.4),c(0.04,0.4),c(0.001,0.0001),c(0.1,0.01))
system("cp pomExp.lin pomac.lin")
system(paste(neuBin,"sim.par","fishE.inp"),wait=s_wait)



# Read all simulations and change to long format

den1 <- meltDensityOut_NT("Simul/Exp467Density.txt",nrow(ff))

pairKS_SAD(den1)


format(mks[mks$p.adjust>0.05,c(10:13,14:15)],digits=4)

nrow(mks[mks$p.adjust>0.05,c(10:13,14:15)])/nrow(mks)

psa <- mergePairSAD(mks[468,],den1)

require(ggplot2)

(g <- ggplot(psa,aes(x=Rank,y=log(value),colour=parms)) + geom_line())

```

The proportion of equal distributions is 0.30 what happens if we test Dq

